
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX 实时交易 + AI 分析</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }
        
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .right-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .header {
            padding: 15px 20px;
            background: #252525;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 16px;
            font-weight: bold;
            color: #00ff00;
        }
        
        .status {
            font-size: 12px;
            color: #888;
        }
        
        .status.connected {
            color: #00ff00;
        }
        
        .trades-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .trade-row {
            padding: 4px 0;
            border-bottom: 1px solid #222;
        }
        
        .trade-row:hover {
            background: #252525;
        }
        
        .side-buy {
            color: #0f0;
        }
        
        .side-sell {
            color: #f44;
        }
        
        .analysis-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-size: 13px;
            line-height: 1.8;
            color: #aaa;
        }
        
        .analysis-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #252525;
            border-left: 3px solid #00ff00;
            border-radius: 4px;
        }
        
        .analysis-time {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .analysis-content {
            color: #ccc;
            white-space: pre-wrap;
        }
        
        .download-btn {
            padding: 10px 20px;
            margin: 15px 20px;
            background: #00ff00;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .download-btn:hover {
            background: #00dd00;
        }
        
        .stats {
            padding: 10px 20px;
            background: #252525;
            border-top: 1px solid #333;
            font-size: 12px;
            color: #888;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左侧：实时交易流 -->
        <div class="left-panel">
            <div class="header">
                <div class="title">OKX BTC-USDT 实时成交</div>
                <div class="status" id="ws-status">连接中...</div>
            </div>
            <div class="trades-container" id="trades-list"></div>
            <div class="stats" id="stats">总计: 0 笔交易</div>
            <button class="download-btn" onclick="downloadCSV()">下载 CSV 数据</button>
        </div>
        
        <!-- 右侧：AI分析 -->
        <div class="right-panel">
            <div class="header">
                <div class="title">AI 实时分析</div>
                <div class="status" id="ai-status">等待数据...</div>
            </div>
            <div class="analysis-container" id="analysis-list"></div>
        </div>
    </div>

    <script>
        // ===== 配置 =====
        const GEMINI_API_KEY = 'AIzaSyBkwTqPVykDZWm6CrQKDi7uxgCFaNNqGpk';
        const INST_ID = 'BTC-USDT';
        const WS_URL = 'wss://ws.okx.com:8443/ws/v5/public';
        const TIMEZONE = 'Europe/London';
        
        // ===== 全局数据 =====
        let allTrades = [];
        let recentTrades = [];
        let seenIds = new Set();
        let ws = null;
        let analysisInterval = null;
        
        // ===== 时间格式化 =====
        function formatTime(tsMs) {
            const date = new Date(parseInt(tsMs));
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            const ms = String(date.getMilliseconds()).padStart(3, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${ms}`;
        }
        
        // ===== 连接 OKX WebSocket =====
        function connectOKX() {
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log('WebSocket 已连接');
                document.getElementById('ws-status').textContent = '已连接';
                document.getElementById('ws-status').classList.add('connected');
                
                // 订阅交易频道
                const subMsg = {
                    op: 'subscribe',
                    args: [{ channel: 'trades', instId: INST_ID }]
                };
                ws.send(JSON.stringify(subMsg));
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    // 处理订阅确认
                    if (data.event) {
                        console.log('事件:', data.event, data.msg || '');
                        return;
                    }
                    
                    // 处理交易数据
                    if (data.data && Array.isArray(data.data)) {
                        data.data.forEach(trade => {
                            processTrade(trade);
                        });
                    }
                } catch (err) {
                    console.error('解析消息错误:', err);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket 错误:', error);
                document.getElementById('ws-status').textContent = '连接错误';
                document.getElementById('ws-status').classList.remove('connected');
            };
            
            ws.onclose = () => {
                console.log('WebSocket 已断开，5秒后重连...');
                document.getElementById('ws-status').textContent = '已断开';
                document.getElementById('ws-status').classList.remove('connected');
                setTimeout(connectOKX, 5000);
            };
        }
        
        // ===== 处理单笔交易 =====
        function processTrade(trade) {
            const tradeId = trade.tradeId;
            
            // 去重
            if (seenIds.has(tradeId)) return;
            seenIds.add(tradeId);
            
            // 限制内存
            if (seenIds.size > 200000) {
                seenIds.clear();
            }
            
            const ts = parseInt(trade.ts);
            const px = parseFloat(trade.px);
            const sz = parseFloat(trade.sz);
            const price = (px * sz).toFixed(2);
            const side = trade.side;
            const timeStr = formatTime(ts);
            
            const tradeData = {
                time: timeStr,
                px: trade.px,
                sz: trade.sz,
                price: price,
                side: side,
                ts: ts
            };
            
            // 保存到所有交易
            allTrades.push(tradeData);
            
            // 保存到最近5秒交易（用于AI分析）
            recentTrades.push(tradeData);
            
            // 显示在页面
            displayTrade(tradeData);
            
            // 更新统计
            updateStats();
        }
        
        // ===== 显示交易 =====
        function displayTrade(trade) {
            const container = document.getElementById('trades-list');
            const row = document.createElement('div');
            row.className = 'trade-row';
            
            const sideClass = trade.side === 'buy' ? 'side-buy' : 'side-sell';
            row.innerHTML = `<span class="${sideClass}">${trade.time}, ${trade.px}, ${trade.sz}, ${trade.price}, ${trade.side}</span>`;
            
            container.appendChild(row);
            container.scrollTop = container.scrollHeight;
        }
        
        // ===== 更新统计 =====
        function updateStats() {
            document.getElementById('stats').textContent = `总计: ${allTrades.length} 笔交易`;
        }
        
        // ===== AI 分析 =====
        async function analyzeWithGemini() {
            if (recentTrades.length === 0) {
                return;
            }
            
            document.getElementById('ai-status').textContent = '分析中...';
            
            // 准备数据摘要
            const summary = prepareSummary(recentTrades);
            
            // 调用 Gemini API
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `你是加密货币交易分析师。以下是过去5秒的BTC-USDT交易数据：\n\n${summary}\n\n请简短分析：1) 买卖压力 2) 价格趋势 3) 是否有大单。控制在100字内。`
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                const analysis = data.candidates?.[0]?.content?.parts?.[0]?.text || '分析失败';
                
                displayAnalysis(analysis);
                document.getElementById('ai-status').textContent = '最后分析: ' + new Date().toLocaleTimeString();
                
            } catch (err) {
                console.error('AI分析错误:', err);
                document.getElementById('ai-status').textContent = '分析失败';
            }
            
            // 清空最近交易
            recentTrades = [];
        }
        
        // ===== 准备数据摘要 =====
        function prepareSummary(trades) {
            let buyCount = 0, sellCount = 0;
            let buyVolume = 0, sellVolume = 0;
            let prices = [];
            
            trades.forEach(t => {
                const vol = parseFloat(t.sz);
                prices.push(parseFloat(t.px));
                
                if (t.side === 'buy') {
                    buyCount++;
                    buyVolume += vol;
                } else {
                    sellCount++;
                    sellVolume += vol;
                }
            });
            
            const avgPrice = (prices.reduce((a,b) => a+b, 0) / prices.length).toFixed(2);
            const minPrice = Math.min(...prices).toFixed(2);
            const maxPrice = Math.max(...prices).toFixed(2);
            
            return `交易笔数: ${trades.length}
买单: ${buyCount}笔 (${buyVolume.toFixed(4)} BTC)
卖单: ${sellCount}笔 (${sellVolume.toFixed(4)} BTC)
价格范围: ${minPrice} - ${maxPrice} USDT
平均价格: ${avgPrice} USDT`;
        }
        
        // ===== 显示分析结果 =====
        function displayAnalysis(text) {
            const container = document.getElementById('analysis-list');
            const item = document.createElement('div');
            item.className = 'analysis-item';
            
            const timeStr = new Date().toLocaleString('zh-CN', { 
                hour12: false,
                timeZone: TIMEZONE 
            });
            
            item.innerHTML = `
                <div class="analysis-time">${timeStr}</div>
                <div class="analysis-content">${text}</div>
            `;
            
            container.insertBefore(item, container.firstChild);
        }
        
        // ===== 下载 CSV =====
        function downloadCSV() {
            if (allTrades.length === 0) {
                alert('暂无数据');
                return;
            }
            
            let csv = 'time,px,sz,price,side\n';
            allTrades.forEach(t => {
                csv += `${t.time},${t.px},${t.sz},${t.price},${t.side}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const filename = `okx_trades_${new Date().getTime()}.csv`;
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ===== 启动 =====
        window.onload = () => {
            connectOKX();
            
            // 每5秒AI分析一次
            analysisInterval = setInterval(analyzeWithGemini, 5000);
        };
        
        // ===== 清理 =====
        window.onbeforeunload = () => {
            if (ws) ws.close();
            if (analysisInterval) clearInterval(analysisInterval);
        };
    </script>
</body>
</html>
