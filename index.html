<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX 实时交易 + AI 分析</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #0a0e27;
            color: #ccc;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }
        
        .left-panel {
            width: 40%;
            display: flex;
            flex-direction: column;
            background: #151b3d;
            border: 1px solid #1e2a5e;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .right-panel {
            width: 60%;
            display: flex;
            flex-direction: column;
        }
        
        .analysis-section {
            display: flex;
            flex-direction: column;
            background: #151b3d;
            border: 1px solid #1e2a5e;
            border-radius: 8px;
            overflow: hidden;
            flex: 1;
        }
        
        .header {
            padding: 15px 20px;
            background: #1a2142;
            border-bottom: 1px solid #1e2a5e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .title {
            font-size: 16px;
            font-weight: bold;
            color: #64b5f6;
        }
        
        .pair-selector {
            padding: 5px 10px;
            background: #0a0e27;
            border: 1px solid #3d5afe;
            border-radius: 4px;
            color: #64b5f6;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
        }
        
        .pair-selector:focus {
            outline: none;
            border-color: #5c6bc0;
        }
        
        .status {
            font-size: 12px;
            color: #546e7a;
        }
        
        .status.connected {
            color: #00e676;
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 1.8fr 1fr 1fr 1.2fr 0.8fr;
            padding: 10px 20px;
            background: #1a2142;
            border-bottom: 2px solid #1e2a5e;
            font-weight: bold;
            font-size: 13px;
            color: #64b5f6;
            text-align: right;
        }
        
        .table-header > div:first-child {
            text-align: left;
        }
        
        .trades-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            font-size: 13px;
        }
        
        .trade-row {
            display: grid;
            grid-template-columns: 1.8fr 1fr 1fr 1.2fr 0.8fr;
            padding: 10px 20px;
            border-bottom: 1px solid #1a1f3a;
            line-height: 1.8;
            color: #90a4ae;
            text-align: right;
        }
        
        .trade-row > div:first-child {
            text-align: left;
        }
        
        .trade-row:hover {
            background: #1a2142;
        }
        
        .side-buy {
            color: #00e5ff;
            font-weight: bold;
        }
        
        .side-sell {
            color: #ff6d00;
            font-weight: bold;
        }
        
        .analysis-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-size: 13px;
            line-height: 1.8;
            color: #b0bec5;
        }
        
        .analysis-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #1a2142;
            border-left: 3px solid #3d5afe;
            border-radius: 4px;
        }
        
        .analysis-time {
            font-size: 11px;
            color: #546e7a;
            margin-bottom: 8px;
        }
        
        .analysis-content {
            color: #cfd8dc;
            white-space: pre-wrap;
        }
        
        .download-btn {
            padding: 12px 20px;
            margin: 15px 20px;
            background: #3d5afe;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .download-btn:hover {
            background: #5c6bc0;
        }
        
        .stats {
            padding: 10px 20px;
            background: #1a2142;
            border-top: 1px solid #1e2a5e;
            font-size: 12px;
            color: #546e7a;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0a0e27;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #1e2a5e;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #3d5afe;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左侧：实时交易流 (40%) -->
        <div class="left-panel">
            <div class="header">
                <div class="header-left">
                    <div class="title">实时成交</div>
                    <select class="pair-selector" id="pair-selector" onchange="changePair()">
                        <option value="BTC-USDT">BTC-USDT</option>
                        <option value="ETH-USDT">ETH-USDT</option>
                        <option value="SOL-USDT">SOL-USDT</option>
                        <option value="BNB-USDT">BNB-USDT</option>
                        <option value="XRP-USDT">XRP-USDT</option>
                        <option value="DOGE-USDT">DOGE-USDT</option>
                        <option value="ADA-USDT">ADA-USDT</option>
                    </select>
                </div>
                <div class="status" id="ws-status">连接中...</div>
            </div>
            <div class="table-header">
                <div>时间 (time)</div>
                <div>价格 (px)</div>
                <div>数量 (sz)</div>
                <div>金额 (price)</div>
                <div>方向 (side)</div>
            </div>
            <div class="trades-container" id="trades-list"></div>
            <div class="stats" id="stats">总计: 0 笔交易</div>
            <button class="download-btn" onclick="downloadCSV()">下载 CSV 数据</button>
        </div>
        
        <!-- 右侧 (60%) -->
        <div class="right-panel">
            <!-- AI分析 -->
            <div class="analysis-section">
                <div class="header">
                    <div class="title">AI 实时分析 (Groq)</div>
                    <div class="status" id="ai-status">等待数据...</div>
                </div>
                <div class="analysis-container" id="analysis-list"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== 配置 =====
        const GROQ_API_KEY = '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';
        let INST_ID = 'BTC-USDT';
        const WS_URL = 'wss://ws.okx.com:8443/ws/v5/public';
        const TIMEZONE = 'Europe/London';
        
        // ===== 全局数据 =====
        let allTrades = [];
        let recentTrades = [];
        let seenIds = new Set();
        let ws = null;
        let analysisInterval = null;
        let autoScroll = true;
        
        // ===== 时间格式化 =====
        function formatTime(tsMs) {
            const date = new Date(parseInt(tsMs));
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            const ms = String(date.getMilliseconds()).padStart(3, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${ms}`;
        }
        
        // ===== 切换交易对 =====
        function changePair() {
            const selector = document.getElementById('pair-selector');
            INST_ID = selector.value;
            
            allTrades = [];
            recentTrades = [];
            seenIds.clear();
            document.getElementById('trades-list').innerHTML = '';
            document.getElementById('analysis-list').innerHTML = '';
            updateStats();
            
            if (ws) {
                ws.close();
            }
            setTimeout(() => connectOKX(), 500);
        }
        
        // ===== 监听滚动事件 =====
        function setupScrollListener() {
            const container = document.getElementById('trades-list');
            
            container.addEventListener('scroll', () => {
                const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 10;
                autoScroll = isAtBottom;
            });
        }
        
        // ===== 连接 OKX WebSocket =====
        function connectOKX() {
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log('WebSocket 已连接');
                document.getElementById('ws-status').textContent = '已连接';
                document.getElementById('ws-status').classList.add('connected');
                
                const subMsg = {
                    op: 'subscribe',
                    args: [{ channel: 'trades', instId: INST_ID }]
                };
                ws.send(JSON.stringify(subMsg));
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.event) {
                        console.log('事件:', data.event, data.msg || '');
                        return;
                    }
                    
                    if (data.data && Array.isArray(data.data)) {
                        data.data.forEach(trade => {
                            processTrade(trade);
                        });
                    }
                } catch (err) {
                    console.error('解析消息错误:', err);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket 错误:', error);
                document.getElementById('ws-status').textContent = '连接错误';
                document.getElementById('ws-status').classList.remove('connected');
            };
            
            ws.onclose = () => {
                console.log('WebSocket 已断开，5秒后重连...');
                document.getElementById('ws-status').textContent = '已断开';
                document.getElementById('ws-status').classList.remove('connected');
                setTimeout(connectOKX, 5000);
            };
        }
        
        // ===== 处理单笔交易 =====
        function processTrade(trade) {
            const tradeId = trade.tradeId;
            
            if (seenIds.has(tradeId)) return;
            seenIds.add(tradeId);
            
            if (seenIds.size > 200000) {
                seenIds.clear();
            }
            
            const ts = parseInt(trade.ts);
            const px = parseFloat(trade.px);
            const sz = parseFloat(trade.sz);
            const price = (px * sz).toFixed(2);
            const side = trade.side;
            const timeStr = formatTime(ts);
            
            const tradeData = {
                time: timeStr,
                px: trade.px,
                sz: trade.sz,
                price: price,
                side: side,
                ts: ts
            };
            
            allTrades.push(tradeData);
            recentTrades.push(tradeData);
            
            displayTrade(tradeData);
            updateStats();
        }
        
        // ===== 显示交易 =====
        function displayTrade(trade) {
            const container = document.getElementById('trades-list');
            const row = document.createElement('div');
            row.className = 'trade-row';
            
            const sideClass = trade.side === 'buy' ? 'side-buy' : 'side-sell';
            row.innerHTML = `
                <div>${trade.time}</div>
                <div>${trade.px}</div>
                <div>${trade.sz}</div>
                <div>${trade.price}</div>
                <div class="${sideClass}">${trade.side}</div>
            `;
            
            container.appendChild(row);
            
            if (autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // ===== 更新统计 =====
        function updateStats() {
            document.getElementById('stats').textContent = `总计: ${allTrades.length} 笔交易`;
        }
        
        // ===== AI 分析 (使用 Groq) =====
        async function analyzeWithGroq() {
            if (recentTrades.length === 0) {
                return;
            }
            
            document.getElementById('ai-status').textContent = '分析中...';
            
            const summary = prepareSummary(recentTrades);
            
            try {
                const url = 'https://api.groq.com/openai/v1/chat/completions';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [{
                            role: 'user',
                            content: `你是一名专业的加密货币交易分析师。

我正在监控 ${INST_ID} 交易对的实时市场数据。${INST_ID} 是比特币(BTC)对美元稳定币(USDT)的交易对，价格单位为USDT。

以下是过去20秒内的真实交易统计数据：

${summary}

数据说明：
- 交易笔数：过去20秒发生的成交次数
- 买单：主动买入的交易（买方吃单），数量越多表示买入意愿强
- 卖单：主动卖出的交易（卖方吃单），数量越多表示卖出压力大
- 币：指BTC的数量
- 价格范围：20秒内的最低价和最高价
- 平均价格：20秒内的成交均价

请基于这些真实交易数据，用简洁专业的语言分析（不超过120字）：
1. 买卖压力对比情况
2. 短期价格趋势判断
3. 是否有异常大额交易`
                        }],
                        temperature: 0.7,
                        max_tokens: 300
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API错误:', response.status, errorText);
                    throw new Error(`API返回错误: ${response.status}`);
                }
                
                const data = await response.json();
                const analysis = data.choices?.[0]?.message?.content || '分析数据为空';
                
                displayAnalysis(analysis);
                document.getElementById('ai-status').textContent = '最后分析: ' + new Date().toLocaleTimeString();
                
            } catch (err) {
                console.error('AI分析错误:', err);
                displayAnalysis(`分析失败: ${err.message}`);
                document.getElementById('ai-status').textContent = '分析失败';
            }
            
            recentTrades = [];
        }
        
        // ===== 准备数据摘要 =====
        function prepareSummary(trades) {
            let buyCount = 0, sellCount = 0;
            let buyVolume = 0, sellVolume = 0;
            let prices = [];
            
            trades.forEach(t => {
                const vol = parseFloat(t.sz);
                prices.push(parseFloat(t.px));
                
                if (t.side === 'buy') {
                    buyCount++;
                    buyVolume += vol;
                } else {
                    sellCount++;
                    sellVolume += vol;
                }
            });
            
            const avgPrice = (prices.reduce((a,b) => a+b, 0) / prices.length).toFixed(2);
            const minPrice = Math.min(...prices).toFixed(2);
            const maxPrice = Math.max(...prices).toFixed(2);
            
            return `交易笔数: ${trades.length}
买单: ${buyCount}笔 (${buyVolume.toFixed(4)} 币)
卖单: ${sellCount}笔 (${sellVolume.toFixed(4)} 币)
价格范围: ${minPrice} - ${maxPrice} USDT
平均价格: ${avgPrice} USDT`;
        }
        
        // ===== 显示分析结果 =====
        function displayAnalysis(text) {
            const container = document.getElementById('analysis-list');
            const item = document.createElement('div');
            item.className = 'analysis-item';
            
            const timeStr = new Date().toLocaleString('zh-CN', { 
                hour12: false,
                timeZone: TIMEZONE 
            });
            
            item.innerHTML = `
                <div class="analysis-time">${timeStr}</div>
                <div class="analysis-content">${text}</div>
            `;
            
            container.insertBefore(item, container.firstChild);
        }
        
        // ===== 下载 CSV =====
        function downloadCSV() {
            if (allTrades.length === 0) {
                alert('暂无数据');
                return;
            }
            
            let csv = 'time,px,sz,price,side\n';
            allTrades.forEach(t => {
                csv += `${t.time},${t.px},${t.sz},${t.price},${t.side}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const filename = `okx_${INST_ID.replace('-', '_')}_${new Date().getTime()}.csv`;
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ===== 启动 =====
        window.onload = () => {
            connectOKX();
            setupScrollListener();
            
            analysisInterval = setInterval(analyzeWithGroq, 20000);
        };
        
        // ===== 清理 =====
        window.onbeforeunload = () => {
            if (ws) ws.close();
            if (analysisInterval) clearInterval(analysisInterval);
        };
    </script>
</body>
</html>
